import requests
import os
import datetime
import smtplib
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText

# --- ì„¤ì • ---
# GitHub Secretsë¡œë¶€í„° API í‚¤ ë° ì´ë©”ì¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
NEWS_API_KEY = os.environ.get('NEWS_API_KEY')
GMAIL_ADDRESS = os.environ.get('GMAIL_ADDRESS')
GMAIL_APP_PASSWORD = os.environ.get('GMAIL_APP_PASSWORD')
RECIPIENT_EMAIL = os.environ.get('RECIPIENT_EMAIL')

KEYWORDS = ["ì´ë™í†µì‹  ë‹¨ë§ê¸°", "ëª¨ë€ ì¹©ì…‹", "ì˜¨ë””ë°”ì´ìŠ¤ AI", "ì˜¨ë””ë°”ì´ìŠ¤ ë³´ì•ˆ"]

def fetch_news(keyword):
    """ì§€ì •ëœ í‚¤ì›Œë“œë¡œ NewsAPIì—ì„œ ìµœì‹  ë‰´ìŠ¤ 10ê°œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤."""
    print(f"'{keyword}' í‚¤ì›Œë“œë¡œ ë‰´ìŠ¤ ê°€ì ¸ì˜¤ëŠ” ì¤‘...")
    today = datetime.date.today()
    # ì™¸êµ­ ì‚¬ì´íŠ¸ë¥¼ ê³ ë ¤í•˜ì—¬ í•˜ë£¨ ì „ ë‚ ì§œë¶€í„° ê²€ìƒ‰
    from_date = today - datetime.timedelta(days=1)
    
    url = (
        "https://newsapi.org/v2/everything?"
        f"q={keyword}&"
        f"from={from_date.isoformat()}&"
        "language=ko&"  # í•œêµ­ì–´ ë‰´ìŠ¤ ìš°ì„  ê²€ìƒ‰
        "pageSize=10&"
        "sortBy=publishedAt&" # ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
        f"apiKey={NEWS_API_KEY}"
    )
    
    try:
        response = requests.get(url)
        response.raise_for_status()  # HTTP ì˜¤ë¥˜ ë°œìƒ ì‹œ ì˜ˆì™¸ ë°œìƒ
        news_data = response.json()
        print(f"'{keyword}' í‚¤ì›Œë“œë¡œ {len(news_data.get('articles', []))}ê°œì˜ ë‰´ìŠ¤ ìˆ˜ì§‘ ì™„ë£Œ.")
        return news_data.get('articles', [])
    except requests.exceptions.RequestException as e:
        print(f"ë‰´ìŠ¤ API ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ ({keyword}): {e}")
        return []
    except Exception as e:
        print(f"ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ ë°œìƒ ({keyword}): {e}")
        return []

def create_html_template(news_by_keyword):
    """ìˆ˜ì§‘ëœ ë‰´ìŠ¤ ë°ì´í„°ë¡œ HTML ë‚´ìš©ì„ ìƒì„±í•©ë‹ˆë‹¤."""
    print("HTML í…œí”Œë¦¿ ìƒì„± ì¤‘...")
    kst_time = datetime.datetime.now(datetime.timezone(datetime.timedelta(hours=9)))
    title_date = kst_time.strftime("%Yë…„ %mì›” %dì¼")
    
    body_content = ""
    for keyword, articles in news_by_keyword.items():
        body_content += f"<h2>ì£¼ìš” í‚¤ì›Œë“œ: {keyword}</h2>\n"
        if not articles:
            body_content += "<p>ê´€ë ¨ ìµœì‹  ë‰´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>\n"
            continue
            
        body_content += "<ul>\n"
        for article in articles:
            title = article.get('title', 'ì œëª© ì—†ìŒ')
            url = article.get('url', '#')
            # ìš”ì•½ì´ ë„ˆë¬´ ê¸¸ ê²½ìš° 200ìë¡œ ì œí•œ
            description = article.get('description', 'ìš”ì•½ ì—†ìŒ') or "ìš”ì•½ ì—†ìŒ"
            summary = (description[:200] + '...') if len(description) > 200 else description
            
            body_content += f"""
            <li>
                <h3><a href="{url}" target="_blank" rel="noopener noreferrer">{title}</a></h3>
                <p>{summary}</p>
            </li>
            """
        body_content += "</ul>\n<hr>\n"

    html = f"""
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ì˜¤ëŠ˜ì˜ í…Œí¬ ë‰´ìŠ¤ ({title_date})</title>
        <style>
            body {{ font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; margin: 20px; }}
            h1 {{ color: #333; }}
            h2 {{ color: #555; border-bottom: 2px solid #eee; padding-bottom: 10px; }}
            ul {{ list-style-type: none; padding-left: 0; }}
            li {{ margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 5px; }}
            h3 a {{ text-decoration: none; color: #0056b3; }}
            h3 a:hover {{ text-decoration: underline; }}
            p {{ color: #666; }}
            .footer {{ text-align: center; margin-top: 30px; font-size: 0.9em; color: #888; }}
        </style>
    </head>
    <body>
        <h1>ğŸ“° ì˜¤ëŠ˜ì˜ í…Œí¬ ë‰´ìŠ¤ ({title_date})</h1>
        <p>ì´ í˜ì´ì§€ëŠ” GitHub Actionsì— ì˜í•´ ë§¤ì¼ ì˜¤ì „ 9ì‹œì— ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.</p>
        <hr>
        {body_content}
        <div class="footer">
            <p>Generated by Python & GitHub Actions</p>
        </div>
    </body>
    </html>
    """
    print("HTML í…œí”Œë¦¿ ìƒì„± ì™„ë£Œ.")
    return html

def save_html_file(html_content):
    """ìƒì„±ëœ HTML ë‚´ìš©ì„ index.html íŒŒì¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤."""
    try:
        with open("index.html", "w", encoding="utf-8") as f:
            f.write(html_content)
        print("index.html íŒŒì¼ ì €ì¥ ì™„ë£Œ.")
    except IOError as e:
        print(f"íŒŒì¼ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")

def send_email(html_content):
    """HTML ë‚´ìš©ì„ ì´ë©”ì¼ë¡œ ë°œì†¡í•©ë‹ˆë‹¤."""
    if not all([GMAIL_ADDRESS, GMAIL_APP_PASSWORD, RECIPIENT_EMAIL]):
        print("ì´ë©”ì¼ ë°œì†¡ì— í•„ìš”í•œ ì •ë³´(Secrets)ê°€ ë¶€ì¡±í•˜ì—¬ ì´ë©”ì¼ì„ ë°œì†¡í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
        return

    print(f"{RECIPIENT_EMAIL} ì£¼ì†Œë¡œ ì´ë©”ì¼ ë°œì†¡ ì‹œë„...")
    kst_time = datetime.datetime.now(datetime.timezone(datetime.timedelta(hours=9)))
    subject = f"ğŸ“° ì˜¤ëŠ˜ì˜ í…Œí¬ ë‰´ìŠ¤ ë¸Œë¦¬í•‘ ({kst_time.strftime('%Y-%m-%d')})"

    msg = MIMEMultipart('alternative')
    msg['Subject'] = subject
    msg['From'] = GMAIL_ADDRESS
    msg['To'] = RECIPIENT_EMAIL
    
    part = MIMEText(html_content, 'html')
    msg.attach(part)

    try:
        with smtplib.SMTP_SSL('smtp.gmail.com', 465) as smtp:
            smtp.login(GMAIL_ADDRESS, GMAIL_APP_PASSWORD)
            smtp.send_message(msg)
        print("ì´ë©”ì¼ ë°œì†¡ ì„±ê³µ!")
    except Exception as e:
        print(f"ì´ë©”ì¼ ë°œì†¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")

if __name__ == "__main__":
    if not NEWS_API_KEY:
        print("ì˜¤ë¥˜: NEWS_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. GitHub Secretsë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.")
    else:
        all_news = {}
        for kw in KEYWORDS:
            all_news[kw] = fetch_news(kw)
        
        html_output = create_html_template(all_news)
        save_html_file(html_output)
        send_email(html_output)
        print("ëª¨ë“  ì‘ì—… ì™„ë£Œ.")
